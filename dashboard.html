<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Advocate Diary</title>
    
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="style.css?v=47.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DASHBOARD SPECIFIC STYLES --- */
        :root {
            --card-bg: var(--bg-card, #1e1e1e);
            --text-primary: var(--text-main, #ffffff);
            --text-secondary: var(--text-light, #aaaaaa);
        }

        body { background-color: var(--bg-body, #121212); color: var(--text-primary); }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Area */
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color, #333);
        }
        .dash-title h1 { margin: 0; font-size: 1.8rem; }
        .dash-title p { margin: 5px 0 0; color: var(--text-secondary); font-size: 0.9rem; }

        /* 1. STATS CARDS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color, #333);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary, #0d6efd); }

        .stat-info h3 { margin: 0; font-size: 2rem; font-weight: 700; }
        .stat-info p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
            background: rgba(255,255,255,0.05);
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }

        /* Colors for Cards */
        .card-blue .stat-info h3 { color: #3b82f6; } .card-blue .stat-icon { color: #3b82f6; }
        .card-green .stat-info h3 { color: #10b981; } .card-green .stat-icon { color: #10b981; }
        .card-orange .stat-info h3 { color: #f59e0b; } .card-orange .stat-icon { color: #f59e0b; }
        .card-purple .stat-info h3 { color: #8b5cf6; } .card-purple .stat-icon { color: #8b5cf6; }

        /* 2. CHARTS GRID */
        .charts-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color, #333);
            border-radius: 12px;
            padding: 20px;
            height: 400px;
            position: relative;
        }
        .chart-header { margin-bottom: 15px; font-weight: 600; color: var(--text-secondary); }

        /* Loader */
        .loader-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-body, #121212);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }

        @media (max-width: 768px) {
            .charts-wrapper { grid-template-columns: 1fr; }
            .dash-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .stat-card { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div style="font-size: 3rem;">üìä</div>
        <p>Analyzing Case Data...</p>
    </div>

    <div class="dashboard-container">
        <header class="dash-header">
            <div class="dash-title">
                <h1>Analytics Dashboard</h1>
                <p>Welcome back, <span id="adminName">Advocate</span></p>
            </div>
            <a href="index.html" class="header-link" style="background:var(--bg-input); padding:10px 20px; border-radius:8px; text-decoration:none; color:white;">‚¨Ö Back to Diary</a>
        </header>

        <section class="stats-grid">
            <div class="stat-card card-blue">
                <div class="stat-info"><h3 id="statTotal">0</h3><p>Total Cases</p></div>
                <div class="stat-icon">üìÇ</div>
            </div>
            <div class="stat-card card-orange">
                <div class="stat-info"><h3 id="statActive">0</h3><p>Active Cases</p></div>
                <div class="stat-icon">‚öñÔ∏è</div>
            </div>
            <div class="stat-card card-green">
                <div class="stat-info"><h3 id="statClosed">0</h3><p>Decided Cases</p></div>
                <div class="stat-icon">‚úÖ</div>
            </div>
            <div class="stat-card card-purple">
                <div class="stat-info"><h3 id="statClients">0</h3><p>Clients</p></div>
                <div class="stat-icon">üë•</div>
            </div>
        </section>

        <section class="charts-wrapper">
            <div class="chart-container">
                <div class="chart-header">Case Status Ratio</div>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-header">Case Volume (By Nature)</div>
                <canvas id="natureChart"></canvas>
            </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBpe3oaDibo7Y9ZaPxf5hJtRyI6PhTY344", 
            authDomain: "advocate-diary-co.firebaseapp.com", 
            projectId: "advocate-diary-co", 
            storageBucket: "advocate-diary-co.appspot.com", 
            messagingSenderId: "809588634104", 
            appId: "1:809588634104:web:f5d4838294ad602aeb660d", 
            measurementId: "G-53VM0EZCWC" 
        }; 
        firebase.initializeApp(firebaseConfig);
    </script>
    <script src="theme.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const db = firebase.firestore();

            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('adminName').textContent = user.displayName || user.email.split('@')[0];
                    loadAnalytics(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });

            async function loadAnalytics(uid) {
                try {
                    const casesSnap = await db.collection('users').doc(uid).collection('cases').where('isDeleted', '==', false).get();
                    const clientsSnap = await db.collection('users').doc(uid).collection('clients').where('isDeleted', '==', false).get();

                    const cases = casesSnap.docs.map(doc => doc.data());
                    const totalCases = cases.length;
                    const totalClients = clientsSnap.size;

                    const closedCount = cases.filter(c => c.isClosed).length;
                    const activeCount = totalCases - closedCount;

                    animateCounter("statTotal", totalCases);
                    animateCounter("statActive", activeCount);
                    animateCounter("statClosed", closedCount);
                    animateCounter("statClients", totalClients);

                    const natureCounts = {};
                    cases.forEach(c => {
                        const nature = c.nature || "Other";
                        natureCounts[nature] = (natureCounts[nature] || 0) + 1;
                    });

                    renderCharts(activeCount, closedCount, natureCounts);
                    document.getElementById('loader').style.display = 'none';

                } catch (error) {
                    console.error("Error loading analytics:", error);
                    alert("Error loading data. Check console for details.");
                }
            }

            function renderCharts(active, closed, natureData) {
                Chart.defaults.color = '#aaaaaa';
                Chart.defaults.borderColor = '#333333';

                const ctx1 = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active Cases', 'Decided Cases'],
                        datasets: [{
                            data: [active, closed],
                            backgroundColor: ['#f59e0b', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                const ctx2 = document.getElementById('natureChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(natureData),
                        datasets: [{
                            label: 'Cases',
                            data: Object.values(natureData),
                            backgroundColor: '#3b82f6',
                            borderRadius: 5
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } } 
                    }
                });
            }

            function animateCounter(id, target) {
                const element = document.getElementById(id);
                let current = 0;
                const increment = Math.ceil(target / 20) || 1;
                if(target === 0) { element.textContent = "0"; return; }
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = current;
                    }
                }, 30);
            }
        });
    </script>
</body>
</html>